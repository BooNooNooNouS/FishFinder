import{r as u,i as t,j as i,Y as ue,S as me,B as _,G as S,bU as Q,cG as J,ar as U,aV as V,aY as pe,dv as be}from"./vendor-DM3YzW4g.js";import{q as he,P as Z}from"./index-DOtB5fjC.js";import{A as w}from"./ActionButton-t5SfA8IW.js";import{f as fe,e as G,R as xe,a as ke,u as je,I as ye}from"./InvenTreeTable-CvoMTeKF.js";import{b as W,m as C,U as h,A as x,e as we}from"./index-620rTnyc.js";import{f as k,u as T,a as Ce,b as ge}from"./UseForm-Dpdzd-Qg.js";import{O as Re}from"./OrderPartsWizard-uRgksWFO.js";import{d as ve,e as Se}from"./BuildOrderTable-BxzAx3pW.js";import{u as Te}from"./UseStatusCodes-DrhwB27P.js";import{f as Le,P as X,T as N,D as qe,B as j,c as Ae}from"./ColumnRenderers-BrlSSC84.js";import{R as Ie}from"./RowExpansionIcon-BT70cimX.js";import{a as H}from"./ThemeContext-D5ZWpaIU.js";function Me({lineItem:o,onEditAllocation:a,onDeleteAllocation:f}){const p=W(),y=H(),b=u.useMemo(()=>[{accessor:"part",title:t._({id:"vgP+9p"}),render:r=>i.jsx(X,{part:r.part_detail})},{accessor:"quantity",title:t._({id:"VbWX2u"}),render:r=>{var c;return(c=r.stock_item_detail)!=null&&c.serial?`# ${r.stock_item_detail.serial}`:r.quantity}},{accessor:"stock_item_detail.batch",title:t._({id:"rsx3xA"})},Le({accessor:"location_detail"}),{accessor:"---actions---",title:" ",width:50,render:r=>i.jsx(fe,{title:t._({id:"7L01XJ"}),index:r.pk,actions:[G({title:t._({id:"f6f1i/"}),modelType:C.stockitem,modelId:r.stock_item,navigate:y}),xe({hidden:!a||!p.hasChangeRole(h.build),onClick:()=>{a==null||a(r.pk)}}),ke({hidden:!f||!p.hasDeleteRole(h.build),onClick:()=>{f==null||f(r.pk)}})]})}],[p,a,f]);return i.jsx(ue,{p:"md",children:i.jsx(me,{gap:"xs",children:i.jsx(he,{minHeight:50,withTableBorder:!0,withColumnBorders:!0,striped:!0,pinLastColumn:!0,idAccessor:"pk",columns:b,records:o.filteredAllocations??o.allocations})})})}function Ne({build:o,output:a,params:f={}}){const p=W(),y=H(),b=Te({modelType:C.build}),r=u.useMemo(()=>!!(a!=null&&a.pk),[a]),c=je(r?"buildline-output":"buildline"),L=u.useMemo(()=>(o==null?void 0:o.status)==b.PRODUCTION||(o==null?void 0:o.status)==b.PENDING||(o==null?void 0:o.status)==b.ON_HOLD,[o,b]),K=u.useMemo(()=>[{name:"allocated",label:t._({id:"A/ybx7"}),description:t._({id:"qhfAiQ"})},{name:"available",label:t._({id:"csDS2L"}),description:t._({id:"Dg4tQl"})},{name:"consumable",label:t._({id:"duCsZf"}),description:t._({id:"4xoOP+"})},{name:"optional",label:t._({id:"LLAa/9"}),description:t._({id:"JZ0XU+"})},{name:"assembly",label:t._({id:"WL36Yh"}),description:t._({id:"yTd5+B"})},{name:"testable",label:t._({id:"bJsTOf"}),description:t._({id:"LCdyP7"})},{name:"tracked",label:t._({id:"EaG6cP"}),description:t._({id:"lY29Qz"})}],[]),Y=u.useCallback(e=>{const s=(e==null?void 0:e.bom_item_detail)??{},n=[];let l=e==null?void 0:e.available_stock;e.available_substitute_stock>0&&(l+=e.available_substitute_stock,n.push(i.jsx(_,{size:"sm",children:t._({id:"XTe+lK"})},"substitite"))),s.allow_variants&&e.available_variant_stock>0&&(l+=e.available_variant_stock,n.push(i.jsx(_,{size:"sm",children:t._({id:"LdvJ9e"})},"variant"))),e.in_production>0&&n.push(i.jsxs(_,{size:"sm",children:[t._({id:"G1xXyB"}),": ",k(e.in_production)]},"production")),e.on_order>0&&n.push(i.jsxs(_,{size:"sm",children:[t._({id:"/MB+gl"}),": ",k(e.on_order)]},"on-order")),e.external_stock>0&&n.push(i.jsxs(_,{size:"sm",children:[t._({id:"e8fwfT"}),": ",k(e.external_stock)]},"external"));const d=l>=e.quantity-e.allocated;return d||n.push(i.jsx(_,{c:"orange",size:"sm",children:t._({id:"R7+e2m"})},"insufficient")),i.jsx(N,{icon:d?"info":"exclamation",iconColor:d?"blue":"orange",value:l>0?`${k(l)}`:i.jsx(_,{c:"red",style:{fontStyle:"italic"},children:t._({id:"a5n/wL"})}),title:t._({id:"oGd3rK"}),extra:n})},[]),$=u.useMemo(()=>[{accessor:"bom_item",title:t._({id:"dK3Z9j"}),ordering:"part",sortable:!0,switchable:!1,render:e=>{const s=e.allocatedQuantity>0;return i.jsxs(S,{wrap:"nowrap",children:[i.jsx(Ie,{enabled:s,expanded:c.isRowExpanded(e.pk)}),i.jsx(X,{part:e.part_detail})]})}},{accessor:"part_detail.IPN",sortable:!1,title:t._({id:"3wXEsN"})},qe({accessor:"part_detail.description"}),{accessor:"bom_item_detail.reference",ordering:"reference",sortable:!0,title:t._({id:"N2C89m"})},j({accessor:"bom_item_detail.optional",ordering:"optional",hidden:r,defaultVisible:!1}),j({accessor:"bom_item_detail.consumable",ordering:"consumable",hidden:r,defaultVisible:!1}),j({accessor:"bom_item_detail.allow_variants",ordering:"allow_variants",hidden:r,defaultVisible:!1}),j({accessor:"bom_item_detail.inherited",ordering:"inherited",title:t._({id:"UF/nv9"}),hidden:r,defaultVisible:!1}),j({accessor:"part_detail.trackable",ordering:"trackable",hidden:r,defaultVisible:!1}),{accessor:"bom_item_detail.quantity",sortable:!0,title:t._({id:"O7oMsT"}),defaultVisible:!1,ordering:"unit_quantity",render:e=>{var s,n;return i.jsxs(S,{justify:"space-between",wrap:"nowrap",children:[i.jsx(_,{children:(s=e.bom_item_detail)==null?void 0:s.quantity}),((n=e==null?void 0:e.part_detail)==null?void 0:n.units)&&i.jsxs(_,{size:"xs",children:["[",e.part_detail.units,"]"]})]})}},{accessor:"quantity",title:t._({id:"D91mkk"}),sortable:!0,defaultVisible:!1,switchable:!1,render:e=>{var n,l,d,m;const s=[];return(n=e==null?void 0:e.bom_item_detail)!=null&&n.setup_quantity&&s.push(i.jsxs(_,{size:"sm",children:[t._({id:"uweQpR"}),":"," ",k(e.bom_item_detail.setup_quantity)]},"setup-quantity")),(l=e==null?void 0:e.bom_item_detail)!=null&&l.attrition&&s.push(i.jsxs(_,{size:"sm",children:[t._({id:"SXygdJ"}),": ",e.bom_item_detail.attrition,"%"]},"attrition")),(d=e==null?void 0:e.bom_item_detail)!=null&&d.rounding_multiple&&s.push(i.jsxs(_,{size:"sm",children:[t._({id:"RKbJ2k"}),":"," ",e.bom_item_detail.rounding_multiple]},"rounding-multiple")),i.jsx(N,{title:t._({id:"mbcLng"}),extra:s,value:i.jsxs(S,{justify:"space-between",wrap:"nowrap",children:[i.jsx(_,{children:k(e.requiredQuantity)}),((m=e==null?void 0:e.part_detail)==null?void 0:m.units)&&i.jsxs(_,{size:"xs",children:["[",e.part_detail.units,"]"]})]})})}},{accessor:"available_stock",sortable:!0,switchable:!1,render:Y},{accessor:"in_production",render:e=>{var s;return e.scheduled_to_build>0?i.jsx(Z,{progressLabel:!0,value:e.in_production,maximum:e.scheduled_to_build}):(s=e.part_detail)!=null&&s.is_assembly?0:"-"}},Ae({accessor:"on_order",defaultVisible:!1}),{accessor:"allocated",switchable:!1,sortable:!0,hidden:!L,render:e=>{var s;return(s=e==null?void 0:e.bom_item_detail)!=null&&s.consumable?i.jsx(_,{style:{fontStyle:"italic"},children:t._({id:"f/GbFw"})}):i.jsx(Z,{progressLabel:!0,value:e.allocatedQuantity,maximum:e.requiredQuantity})}}],[r,L,c,a]),ee=ve({create:!0,modalId:"new-build-order"}),[te,ie]=u.useState({}),[q,A]=u.useState(null),[ae,I]=u.useState([]),M=T({url:x.build_order_list,title:t._({id:"UcPKar"}),fields:ee,modalId:"new-build-order",initialData:te,follow:!0,modelType:C.build}),O=T({url:x.build_order_auto_allocate,pk:o.pk,title:t._({id:"L1LMmH"}),fields:{location:{filters:{structural:!1}},exclude_location:{},interchangeable:{},substitutes:{},optional_items:{}},initialData:{location:o.take_from,interchangeable:!0,substitutes:!0,optional_items:!1},successMessage:t._({id:"xYIlpM"}),table:c,preFormContent:i.jsx(Q,{color:"green",title:t._({id:"PjEJ0F"}),children:i.jsx(_,{children:t._({id:"E2byp7"})})})}),g=Se({build:o,output:a,outputId:(a==null?void 0:a.pk)??null,buildId:o.pk,lineItems:ae,onFormSuccess:()=>{c.refreshTable()}}),R=T({url:x.build_order_deallocate,pk:o.pk,title:t._({id:"ZZL0Jx"}),fields:{build_line:{hidden:!0},output:{hidden:!0}},initialData:{build_line:q,output:(a==null?void 0:a.pk)??null},preFormContent:i.jsx(Q,{color:"red",title:t._({id:"ZZL0Jx"}),children:q==null?i.jsx(_,{children:t._({id:"9dNtWo"})}):i.jsx(_,{children:t._({id:"L01aET"})})}),successMessage:t._({id:"er7tfw"}),table:c}),[P,B]=u.useState(0),z=Ce({url:x.build_item_list,pk:P,title:t._({id:"Tqnsor"}),fields:{stock_item:{disabled:!0},quantity:{}},table:c}),D=ge({url:x.build_item_list,pk:P,title:t._({id:"nV5okC"}),table:c}),[se,F]=u.useState([]),v=Re({parts:se}),le=u.useCallback(e=>{var E;const s=e.part_detail??{},n=o.status==b.PRODUCTION,l=((E=e.bom_item_detail)==null?void 0:E.consumable)??!1,d=!!(a!=null&&a.pk),m=n&&!l&&p.hasChangeRole(h.build)&&e.trackable==d,re=n&&!l&&p.hasChangeRole(h.build)&&e.allocated>0&&e.trackable==d,ce=!l&&p.hasAddRole(h.purchase_order)&&s.purchaseable,_e=!l&&p.hasAddRole(h.build)&&s.assembly;return[{icon:i.jsx(J,{}),title:t._({id:"L1LMmH"}),hidden:!m,color:"green",onClick:()=>{I([e]),g.open()}},{icon:i.jsx(U,{}),title:t._({id:"ZZL0Jx"}),hidden:!re,color:"red",onClick:()=>{A(e.pk),R.open()}},{icon:i.jsx(V,{}),title:t._({id:"cUzrZK"}),hidden:!ce,color:"blue",onClick:()=>{F([e.part_detail]),v.openWizard()}},{icon:i.jsx(pe,{}),title:t._({id:"vgTd7I"}),hidden:!_e,color:"blue",onClick:()=>{ie({part:e.part,parent:o.pk,quantity:e.quantity-e.allocated}),M.open()}},G({title:t._({id:"4BxQBj"}),modelType:C.part,modelId:e.part,navigate:y})]},[p,y,a,o,b]),ne=u.useMemo(()=>{const e=o.status==b.PRODUCTION,s=p.hasChangeRole(h.build),n=e&&s;return[i.jsx(w,{icon:i.jsx(be,{}),tooltip:t._({id:"PjEJ0F"}),hidden:!n||r,color:"blue",onClick:()=>{O.open()}},"auto-allocate"),i.jsx(w,{hidden:!p.hasAddRole(h.purchase_order),disabled:!c.hasSelectedRecords,icon:i.jsx(V,{}),color:"blue",tooltip:t._({id:"3u5ICq"}),onClick:()=>{F(c.selectedRecords.filter(l=>{var d,m;return((d=l.part_detail)==null?void 0:d.purchaseable)&&((m=l.part_detail)==null?void 0:m.active)}).map(l=>l.part_detail)),v.openWizard()}},"order-parts"),i.jsx(w,{icon:i.jsx(J,{}),tooltip:t._({id:"L1LMmH"}),hidden:!n,disabled:!c.hasSelectedRecords,color:"green",onClick:()=>{let l=c.selectedRecords.filter(d=>d.allocatedQuantity<d.requiredQuantity).filter(d=>{var m;return!((m=d.bom_item_detail)!=null&&m.consumable)});r?l=l.filter(d=>d.trackable):l=l.filter(d=>!d.trackable),I(l),g.open()}},"allocate-stock"),i.jsx(w,{icon:i.jsx(U,{}),tooltip:t._({id:"ZZL0Jx"}),hidden:!n||r,disabled:c.hasSelectedRecords,color:"red",onClick:()=>{A(null),R.open()}},"deallocate-stock")]},[p,o,b,r,c.hasSelectedRecords,c.selectedRecords]),oe=u.useCallback(e=>e.map(s=>{let n=[...s.allocations];a!=null&&a.pk&&(n=n.filter(m=>m.install_into==a.pk));let l=0,d=s.quantity;return n.forEach(m=>{l+=m.quantity}),a!=null&&a.quantity&&s.bom_item_detail&&(d=a.quantity*s.bom_item_detail.quantity),{...s,filteredAllocations:n,requiredQuantity:d,allocatedQuantity:l}}),[a]),de=u.useMemo(()=>({allowMultiple:!0,expandable:({record:e})=>c.isRowExpanded(e.pk)||e.allocatedQuantity>0,content:({record:e})=>i.jsx(Me,{lineItem:e,onEditAllocation:s=>{B(s),z.open()},onDeleteAllocation:s=>{B(s),D.open()}})}),[c.isRowExpanded,a]);return i.jsxs(i.Fragment,{children:[O.modal,M.modal,g.modal,R.modal,z.modal,D.modal,v.wizard,i.jsx(ye,{url:we(x.build_line_list),tableState:c,columns:$,props:{params:{...f,build:o.pk,part_detail:!0},tableActions:ne,tableFilters:K,rowActions:le,dataFormatter:oe,enableDownload:!0,enableSelection:!0,rowExpansion:de}})]})}export{Me as B,Ne as a};
//# sourceMappingURL=BuildLineTable-BsmOkFF6.js.map
