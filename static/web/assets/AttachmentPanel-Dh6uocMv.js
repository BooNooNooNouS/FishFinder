import{r as o,i as a,j as t,bf as O,aO as V,S as _,Y,G as z,dN as P,aT as Z,B as g,bS as K,n as f,I as Q,d as W,cw as X,bi as q}from"./vendor-DM3YzW4g.js";import{a as x}from"./NotesPanel-D9Ykw5_S.js";import{A as w}from"./ActionButton-Q09YVtCx.js";import{P as H}from"./index-BOcT9Srm.js";import{u as y,R as ee,a as te,I as ae}from"./InvenTreeTable-Dtz5z1-X.js";import{b as se,e as ne,A as oe}from"./index-D337eai7.js";import{A as M}from"./AttachmentLink-DtsxxBFF.js";import{u as re}from"./DesktopAppView-DyVa6oYc.js";import{u as ie,a as le,b as ce,B as de}from"./UseForm-TWh6_feP.js";function ue(){return[{accessor:"attachment",sortable:!1,switchable:!1,noWrap:!0,render:e=>e.attachment?t.jsx(M,{attachment:e.attachment}):e.link?t.jsx(M,{attachment:e.link,external:!0}):"-",noContext:!0},{accessor:"comment",sortable:!1,render:e=>e.comment},{accessor:"upload_date",sortable:!0,render:e=>t.jsxs(z,{justify:"space-between",children:[t.jsx(g,{children:e.upload_date}),e.user_detail&&t.jsx(K,{size:"xs",children:e.user_detail.username})]})},{accessor:"file_size",sortable:!0,switchable:!0,render:e=>e.attachment?de(e.file_size):"-"}]}function v({filename:e,progress:s}){return t.jsxs(_,{gap:"xs",children:[t.jsx(g,{size:"sm",children:a._({id:"XDpUYO",values:{filename:e}})}),t.jsx(H,{value:s,progressLabel:!1})]})}function me({model_type:e,model_id:s}){const U=re(),r=se(),l=y(`${e}-attachments`),B=o.useMemo(()=>ue(),[]),c=ne(oe.attachment_list),C=o.useMemo(()=>s>0,[s]),b=o.useMemo(()=>r.hasDeletePermission(e),[r,e]),[E,I]=o.useState(!1),R=o.useMemo(()=>r.hasAddPermission(e),[r,e]);function G(n){n.forEach(m=>{const h=new FormData;h.append("attachment",m),h.append("model_type",e),h.append("model_id",s.toString()),I(!0);const A=m.name,p=`attachment-upload-${e}-${s}-${m.name}`;f.show({id:p,title:a._({id:"hIFN6r"}),message:t.jsx(v,{filename:A,progress:0}),color:"blue",loading:!0,autoClose:!1}),U.post(c,h,{timeout:30*1e3,onUploadProgress:i=>{const N=100*((i==null?void 0:i.progress)??0);f.update({id:p,title:a._({id:"hIFN6r"}),color:"blue",loading:!0,autoClose:!1,message:t.jsx(v,{filename:A,progress:N})})}}).then(i=>(f.update({id:p,title:a._({id:"I1EiW4"}),message:a._({id:"JuMBMK",values:{name:A}}),color:"green",autoClose:3500,icon:t.jsx(Q,{}),loading:!1}),l.refreshTable(),i)).catch(i=>(console.error("Error uploading attachment:",m,"->",i),f.update({id:p,title:a._({id:"ae3dey"}),message:a._({id:"GZnmeE"}),color:"red",autoClose:5e3,icon:t.jsx(W,{}),loading:!1}),i)).finally(()=>{I(!1)})})}const[j,S]=o.useState("attachment"),[d,u]=o.useState(void 0),F=o.useMemo(()=>{const n={model_type:{value:e,hidden:!0},model_id:{value:s,hidden:!0},attachment:{},link:{},comment:{}};return j!="link"&&delete n.link,(j!="attachment"||d)&&delete n.attachment,n},[e,s,j,d]),k=ie({url:c,title:a._({id:"p1w/D6"}),fields:F,onFormSuccess:()=>{l.refreshTable()}}),T=le({url:c,pk:d,title:a._({id:"MVvhJ1"}),fields:F,onFormSuccess:n=>{n.pk?l.updateRecord(n):l.refreshTable()}}),D=ce({url:c,pk:d,title:a._({id:"hZfPb3"}),onFormSuccess:()=>{l.refreshTable()}}),L=o.useMemo(()=>[{name:"is_link",label:a._({id:"3QegpG"}),description:a._({id:"r1FQZj"})},{name:"is_file",label:a._({id:"JT83gz"}),description:a._({id:"5LI39K"})}],[]),$=o.useMemo(()=>[t.jsx(w,{tooltip:a._({id:"V8euYO"}),hidden:!r.hasAddPermission(e),icon:t.jsx(O,{}),onClick:()=>{S("attachment"),u(void 0),k.open()}},"add-attachment"),t.jsx(w,{tooltip:a._({id:"DpV4ac"}),hidden:!r.hasAddPermission(e),icon:t.jsx(V,{}),onClick:()=>{S("link"),u(void 0),k.open()}},"add-external-link")],[r,e]),J=o.useCallback(n=>[ee({hidden:!r.hasChangePermission(e),onClick:()=>{u(n.pk),T.open()}}),te({hidden:!b,onClick:()=>{u(n.pk),D.open()}})],[r,e]);return t.jsxs(t.Fragment,{children:[k.modal,T.modal,D.modal,t.jsxs(_,{gap:"xs",children:[C&&t.jsx(ae,{url:c,tableState:l,columns:B,props:{noRecordsText:a._({id:"32o8IC"}),enableSelection:b,enableBulkDelete:b,tableActions:$,tableFilters:L,rowActions:J,params:{model_type:e,model_id:s}}},"attachment-table"),R&&C&&t.jsx(Y,{p:"md",shadow:"xs",radius:"md",children:t.jsx(x,{onDrop:G,loading:E,children:t.jsxs(z,{justify:"center",gap:"lg",mih:100,children:[t.jsx(x.Accept,{children:t.jsx(P,{style:{color:"var(--mantine-color-blue-6)"},stroke:1.5})}),t.jsx(x.Reject,{children:t.jsx(Z,{style:{color:"var(--mantine-color-red-6)"},stroke:1.5})}),t.jsx(x.Idle,{children:t.jsx(P,{style:{color:"var(--mantine-color-dimmed)"},stroke:1.5})}),t.jsx(g,{size:"sm",children:a._({id:"1cbxaa"})})]})},"attachment-dropzone")})]})]})}function Ce({model_type:e,model_id:s}){return{name:"attachments",label:a._({id:"w/Sphq"}),icon:t.jsx(q,{}),content:e&&s?t.jsx(me,{model_type:e,model_id:s}):t.jsx(X,{})}}export{Ce as A};
//# sourceMappingURL=AttachmentPanel-Dh6uocMv.js.map
